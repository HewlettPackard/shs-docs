# HSN NIC Performance Tuning

## Performance analysis using ethtool

ethtool is a standard tool that can be used on the host side to analyze and troubleshoot performance issues on the host side.

Consider the following example.
**Example:**

A Storage server (E1000) is connected with a Mellanox CX6 (200G) connected to the Slingshot Fabric. Clients are connected to the Slingshot Fabric accessing the data from the Storage server. Both the Client and servers are in different Slingshot group. The server is able to produce expected READ performance (200gbit/sec) but the write performance is below the expected level.(lower than the expected~200gb/sec)

In the READ scenario, Clients are requesting for data from the Storage server and the Storage server is pushing the data out to the clients.
In the WRITE scenario, Clients are sending write requests and write directly to the buffer provided by the Storage server that is pushing the data to the Storage server.

1. Capture ethtool data on the Storage Server for the CX6 NIC before the test.

   ```screen
   nwpstor: ethtool -S hsn0 >> before_test.out
   ```

2. Execute the tests.

3. Capture ethtool data on the Storage Server for the CX6 NIC after the test.

   ```screen
   nwpstor: ethtool -S hsn0 >> after_test.out
   ```

4. Analyze the data for any errors, out of buffers, or global pauses that are generated by the NICs during the test that can impact the performance.

   ```screen
   join before_test.out after_test.out |  awk '{printf("%25s \t: %15d , %15d  delta: %15d\n", $1,$2,$3 ,$3-$2);}' > delta.out
   ```

5. Look for pause frames generated during the test.

   ```screen
   rx_pause_ctrl_phy:              217995731 , 217995731  delta: 0
       tx_pause_ctrl_phy:        130836637 ,141797735  	delta: 10961098
       rx_global_pause:       217995731 , 217995731 	delta: 0
   rx_global_pause_duration:        56514674 , 56514674  	delta: 0
       tx_global_pause:       130836637 , 141797735  	delta: 10961098
   tx_global_pause_duration:      3435047420 , 3734351900  delta: 299304480
   rx_global_pause_transition:    108841435 ,  108841435  	delta: 0
   tx_pause_storm_warning_events:       0 ,       0  	delta: 0
   tx_pause_storm_error_events:         0 ,        0  	delta: 0
   ```

In the output shown above, there is a significant pause that is generated for transmit (tx) which is an indication that the host side NIC is unable to consume the incoming data rate.

Possible causes for the same include:

**Incorrect NIC Configuration**

```screen
      grep rx_err delta.out
       rx_err_lane_0_phy:       :         4277307 ,         4692155  delta:          414848
       rx_err_lane_1_phy:       :        21248694 ,        28517626  delta:         7268932
       rx_err_lane_2_phy:       :         2344388 ,         2435173  delta:           90785
       rx_err_lane_3_phy:       :         1865399 ,         1981096  delta:          115697

```

In this specific example, the errors were generated because the recommended PCI relaxed ordering was not set for the CX6 Adapter.  Enabling PCI relaxed ordering increased the performance

Relaxed ordering is a PCIe feature which allows flexibility in the transaction order over the PCIe. This reduces the number of retransmissions on the lane, and increases performance up to four times. By default, mlx5e buffers are created with Relaxed Ordering support when firmware capabilities are on and the PCI subsystem reports that the CPU is not on the kernel's blocklist. `cx_tool.py` is a config script provided for the Mellanox CX6 adapter for configuring the NIC on Storage server (E1000) with the required optimal settings

```screen
[root@nwpstor00 admin]/opt/firmware/mellanox/cx_tool.py
[root@nwpstor00 admin]#  'mlxconfig -e -d /dev/mst/mt4123_pciconf0 query | egrep '"'"'\*|Next'"'"'' | dshbak -c
----------------
----------------
Configurations:                      Default            Current          Next Boot
*        LINK_TYPE_P1                  IB(1)             ETH(2)            ETH(2)
*        PCI_WR_ORDERING             per_mkey(0)       per_mkey(0)       force_relax(1)
*        EXP_ROM_PXE_ENABLE          True(1)             True(1)          False(0)
The '*' shows parameters with next value different from default/current value.
```

**Limited sizing of ring buffers**

```screen
ethtool -g heth0
Ring parameters for heth0:
Pre-set maximums:
RX: 8192
RX Mini: 0
RX Jumbo: 0
TX: 8192
Current hardware settings:
RX: 1024
RX Mini: 0
RX Jumbo: 0
TX: 1024
ethtool --set-ring heth0 rx 8192 rx-mini 0 rx-jumbo 0 tx 8192
```

**Hardware errors like Memory, PCI errors (look for errors in syslog)**

**Note**: If the host side does not exhibit any of the above symptoms, look for errors at the fabric level as mentioned in earlier sections.
